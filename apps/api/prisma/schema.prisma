// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  admin
  manager
  staff
}

enum Status {
  active
  inactive
}

enum AttendanceStatus {
  attendance
  absent
  late
  excused
}

model User {
  id         Int      @id @default(autoincrement())
  account    String   @unique
  password   String
  username   String
  role       Role?    @default(staff)
  email      String?  @unique
  status     Status?  @default(active)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  schools              School[]
  courses              Course[]
  students             Student[]
  gradesheets          GradeSheet[]
  attendances          Attendance[]
  salaryBases          SalaryBase[]
  courseSessions       CourseSession[]
  auditLogs            AuditLog[]
}

model School {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  name        String
  description String?
  address     String?
  color       String?  // 自定義顏色（HEX 格式，例如 #1677ff）
  is_active   Boolean? @default(true)
  modifier_id Int?
  modifier    User?    @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  courses      Course[]
  salaryBases  SalaryBase[]
}

model Course {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  grade       Int?
  school_id   Int
  school      School   @relation(fields: [school_id], references: [id], onDelete: Cascade)
  start_time  DateTime
  end_time    DateTime
  day_of_week String // 例如："1,3,5" 表示週一、三、五
  duration    Int // 課程持續時間（分鐘）
  modifier_id Int?
  modifier    User?    @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  students             Student[]
  courseSessions       CourseSession[]
}

model Student {
  id          Int      @id @default(autoincrement())
  name        String
  number      String
  gender      String
  course_id   Int
  course      Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  is_active   Boolean? @default(true)
  modifier_id Int?
  modifier    User?    @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  attendances Attendance[]
  gradesheets GradeSheet[]
}

model Attendance {
  id          Int              @id @default(autoincrement())
  student_id  Int
  student     Student          @relation(fields: [student_id], references: [id], onDelete: Cascade)
  date        DateTime
  status      AttendanceStatus
  modifier_id Int?
  modifier    User?            @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at  DateTime         @default(now())
  updated_at  DateTime         @updatedAt
}

model GradeSheet {
  id          Int      @id @default(autoincrement())
  student_id  Int
  student     Student  @relation(fields: [student_id], references: [id], onDelete: Cascade)
  score       Float
  description String?
  exam_date   DateTime
  modifier_id Int?
  modifier    User?    @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model SalaryBase {
  id           Int      @id @default(autoincrement())
  name         String
  hourly_rate  Float
  min_students Int?     // 最小人數（null 表示固定薪資）
  max_students Int?     // 最大人數（null 表示無上限）
  description  String?
  is_active    Boolean  @default(true)
  modifier_id  Int?
  modifier     User?    @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  schools          School[]         // 多對多：可被多個學校共用
  courseSessions   CourseSession[]
}

model CourseSession {
  id                   Int         @id @default(autoincrement())
  course_id            Int
  course               Course      @relation(fields: [course_id], references: [id], onDelete: Cascade)
  date                 DateTime
  actual_student_count Int         @default(0)
  is_cancelled         Boolean     @default(false) // 是否停課
  salary_amount        Float?      // 計算出的薪資金額
  salary_base_id       Int?        // 匹配到的薪資級距
  salaryBase           SalaryBase? @relation(fields: [salary_base_id], references: [id], onDelete: SetNull)
  note                 String?
  modifier_id          Int?
  modifier             User?       @relation(fields: [modifier_id], references: [id], onDelete: SetNull)
  created_at           DateTime    @default(now())
  updated_at           DateTime    @updatedAt
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  action     String   // CREATE, UPDATE, DELETE
  entity     String   // e.g., "School", "Student", "Attendance"
  entity_id  Int?
  user_id    Int?
  user       User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  changes    Json?    // Store what was changed
  ip_address String?
  created_at DateTime @default(now())
}
